---
# Tasks file for ludus_litterbox

- name: Gather Windows facts
  ansible.windows.setup:
    gather_subset:
      - env
      - platform
  tags:
    - always

- name: Check Windows version compatibility
  ansible.builtin.assert:
    that:
      - ansible_os_family == "Windows"
      - ansible_distribution_major_version | int >= 10 or ansible_distribution == "Microsoft Windows Server 2019" or ansible_distribution == "Microsoft Windows Server 2022"
    fail_msg: "This role requires Windows 10/11 or Server 2019/2022"
    success_msg: "Windows version is compatible"
  tags:
    - always

- name: Check if running as administrator
  ansible.windows.win_shell: |
    $currentUser = [Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object Security.Principal.WindowsPrincipal($currentUser)
    if ($principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
      Write-Output "Administrator privileges confirmed"
      exit 0
    } else {
      Write-Output "Administrator privileges required"
      exit 1
    }
  register: admin_check
  when: ludus_litterbox_require_admin
  tags:
    - always

- name: Fail if not running as administrator
  ansible.builtin.fail:
    msg: "This role requires administrator privileges. Please run with elevated permissions."
  when: 
    - ludus_litterbox_require_admin
    - admin_check.rc != 0
  tags:
    - always

- name: Check if Chocolatey is installed
  ansible.windows.win_shell: |
    try {
      choco --version
      exit 0
    } catch {
      exit 1
    }
  register: chocolatey_check
  ignore_errors: true
  when: ludus_litterbox_install_chocolatey
  tags:
    - chocolatey

- name: Install Chocolatey
  ansible.windows.win_shell: |
    Set-ExecutionPolicy Bypass -Scope Process -Force
    [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
    iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
  when: 
    - ludus_litterbox_install_chocolatey
    - chocolatey_check.rc != 0
  tags:
    - chocolatey

- name: Install LitterBox
  when: ludus_litterbox_install
  tags:
    - litterbox
    - install
  block:
    - name: Create LitterBox installation directory
      ansible.windows.win_file:
        path: "{{ ludus_litterbox_install_dir }}"
        state: directory

    - name: Disable Windows Defender for lab environment
      ansible.windows.win_shell: |
        Write-Output "WARNING: Disabling Windows Defender for malware analysis lab"
        
        # Disable Windows Defender Real-time protection
        Set-MpPreference -DisableRealtimeMonitoring $true -Force
        
        # Disable Windows Defender completely via Registry
        $defenderPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender"
        if (!(Test-Path $defenderPath)) {
          New-Item -Path $defenderPath -Force | Out-Null
        }
        Set-ItemProperty -Path $defenderPath -Name "DisableAntiSpyware" -Value 1 -Type DWord -Force
        
        # Disable Windows Defender services
        Stop-Service -Name WinDefend -Force -ErrorAction SilentlyContinue
        Set-Service -Name WinDefend -StartupType Disabled -ErrorAction SilentlyContinue
        
        # Disable Windows Defender via Group Policy
        $gpoPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection"
        if (!(Test-Path $gpoPath)) {
          New-Item -Path $gpoPath -Force | Out-Null
        }
        Set-ItemProperty -Path $gpoPath -Name "DisableRealtimeMonitoring" -Value 1 -Type DWord -Force
        Set-ItemProperty -Path $gpoPath -Name "DisableBehaviorMonitoring" -Value 1 -Type DWord -Force
        Set-ItemProperty -Path $gpoPath -Name "DisableOnAccessProtection" -Value 1 -Type DWord -Force
        Set-ItemProperty -Path $gpoPath -Name "DisableScanOnRealtimeEnable" -Value 1 -Type DWord -Force
        
        Write-Output "Windows Defender has been disabled for lab use"
      when: ludus_litterbox_disable_defender
      tags:
        - defender
        - dangerous

    - name: Check if Python is installed
      ansible.windows.win_shell: |
        try {
          $pythonVersion = python --version 2>&1
          if ($pythonVersion -match "Python (\d+\.\d+)") {
            $version = [version]$matches[1]
            if ($version -ge [version]"3.11") {
              Write-Output "Python $version found"
              exit 0
            }
          }
        } catch {}
        exit 1
      register: python_check
      ignore_errors: true
      when: ludus_litterbox_install_python

    - name: Download Python installer
      include_tasks: download_file.yml
      vars:
        file_name: "python-{{ ludus_litterbox_python_version }}-amd64.exe"
        file_url: "https://www.python.org/ftp/python/{{ ludus_litterbox_python_version }}/python-{{ ludus_litterbox_python_version }}-amd64.exe"
        file_dest: "{{ ludus_litterbox_install_dir }}\\python-installer.exe"
      when: 
        - ludus_litterbox_install_python
        - python_check.rc != 0

    - name: Install Python
      ansible.windows.win_shell: |
        Start-Process -FilePath "{{ ludus_litterbox_install_dir }}\\python-installer.exe" `
          -ArgumentList "/quiet", "InstallAllUsers=1", "PrependPath=1", "Include_test=0" `
          -Wait -NoNewWindow
      when: 
        - ludus_litterbox_install_python
        - python_check.rc != 0
      tags:
        - python
      notify:
        - restart python

    - name: Check if git is installed
      ansible.windows.win_shell: |
        try {
          git --version
          exit 0
        } catch {
          exit 1
        }
      register: git_check
      ignore_errors: true

    - name: Install Git using Chocolatey
      ansible.windows.win_shell: |
        if (-not (Get-Command git -ErrorAction SilentlyContinue)) {
          choco install git -y --no-progress
        } else {
          Write-Output "Git already installed"
        }
      when: git_check.rc != 0

    - name: Install Visual C++ Redistributables (required for analysis tools)
      ansible.windows.win_shell: |
        $packages = @("vcredist140")
        foreach ($package in $packages) {
          Write-Output "Installing $package..."
          choco install $package -y --no-progress --ignore-package-exit-codes
        }
      ignore_errors: true
      tags:
        - dependencies

    - name: Clone LitterBox repository
      ansible.windows.win_shell: |
        if (Test-Path "{{ ludus_litterbox_install_dir }}\\LitterBox") {
          cd "{{ ludus_litterbox_install_dir }}\\LitterBox"
          git pull
        } else {
          cd "{{ ludus_litterbox_install_dir }}"
          git clone {{ ludus_litterbox_repo_url }}
        }

    - name: Create Python virtual environment
      ansible.windows.win_shell: |
        cd "{{ ludus_litterbox_install_dir }}\\LitterBox"
        python -m venv venv
      args:
        creates: "{{ ludus_litterbox_install_dir }}\\LitterBox\\venv"

    - name: Install Python requirements
      ansible.windows.win_shell: |
        cd "{{ ludus_litterbox_install_dir }}\\LitterBox"
        .\\venv\\Scripts\\pip.exe install --upgrade pip
        .\\venv\\Scripts\\pip.exe install -r requirements.txt
      register: pip_install
      retries: 3
      delay: 10

    - name: Create necessary directories
      ansible.windows.win_file:
        path: "{{ item }}"
        state: directory
      loop:
        - "{{ ludus_litterbox_install_dir }}\\LitterBox\\config"
        - "{{ ludus_litterbox_install_dir }}\\LitterBox\\uploads"
        - "{{ ludus_litterbox_install_dir }}\\LitterBox\\results"
        - "{{ ludus_litterbox_install_dir }}\\LitterBox\\temp"
        - "{{ ludus_litterbox_install_dir }}\\LitterBox\\logs"
        - "{{ ludus_litterbox_install_dir }}\\LitterBox\\database"
        - "{{ ludus_litterbox_install_dir }}\\LitterBox\\tools"
        - "{{ ludus_litterbox_install_dir }}\\LitterBox\\Scanners"
      tags:
        - directories

    - name: Download and setup analysis tools
      ansible.windows.win_shell: |
        cd "{{ ludus_litterbox_install_dir }}\\LitterBox"
        # The LitterBox repository should include its own tools and scanners
        # Verify critical directories exist
        if (-not (Test-Path "Scanners")) {
          Write-Warning "Scanners directory missing - analysis tools may not work properly"
        }
        if (-not (Test-Path "Utils")) {
          Write-Warning "Utils directory missing - some features may be limited"
        }
        # Set execution policy for PowerShell scripts if needed
        Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force
      tags:
        - tools

    - name: Create Windows Firewall rule for LitterBox
      community.windows.win_firewall_rule:
        name: "LitterBox Web Interface"
        localport: "{{ ludus_litterbox_port }}"
        action: allow
        direction: in
        protocol: tcp
        state: present
        enabled: yes
      when: ludus_litterbox_firewall_rule

    - name: Create batch file to start LitterBox
      ansible.windows.win_template:
        src: start_litterbox.bat.j2
        dest: "{{ ludus_litterbox_install_dir }}\\start_litterbox.bat"

    - name: Create desktop shortcut for LitterBox
      community.windows.win_shortcut:
        src: "{{ ludus_litterbox_install_dir }}\\start_litterbox.bat"
        dest: "C:\\Users\\Public\\Desktop\\LitterBox.lnk"
        icon: "{{ ludus_litterbox_install_dir }}\\LitterBox\\static\\favicon.ico,0"
        description: "LitterBox - Malware Analysis Sandbox"
        directory: "{{ ludus_litterbox_install_dir }}\\LitterBox"
      when: ludus_litterbox_desktop_shortcut

    - name: Add Windows Defender exclusions for malware analysis
      ansible.windows.win_shell: |
        # Add exclusions for LitterBox directories
        Add-MpPreference -ExclusionPath "{{ ludus_litterbox_install_dir }}\\LitterBox" -Force
        Add-MpPreference -ExclusionPath "{{ ludus_litterbox_install_dir }}\\LitterBox\\uploads" -Force
        Add-MpPreference -ExclusionPath "{{ ludus_litterbox_install_dir }}\\LitterBox\\results" -Force
        Add-MpPreference -ExclusionPath "{{ ludus_litterbox_install_dir }}\\LitterBox\\temp" -Force
        
        # Add process exclusions for analysis tools
        Add-MpPreference -ExclusionProcess "python.exe" -Force
        Add-MpPreference -ExclusionProcess "pe-sieve.exe" -Force
        Add-MpPreference -ExclusionProcess "moneta.exe" -Force
        Add-MpPreference -ExclusionProcess "hollows_hunter.exe" -Force
        
        Write-Output "Windows Defender exclusions added for malware analysis"
      when: ludus_litterbox_defender_exclusions
      ignore_errors: true
      tags:
        - defender

    - name: Download GrumpyCats client library
      ansible.windows.win_shell: |
        cd "{{ ludus_litterbox_install_dir }}\\LitterBox"
        if (Test-Path "GrumpyCats") {
          cd GrumpyCats
          git pull
        } else {
          git clone https://github.com/BlackSnufkin/GrumpyCats.git
        }
      ignore_errors: true

    - name: Display installation complete message
      ansible.builtin.debug:
        msg:
          - "LitterBox has been successfully installed!"
          - "Installation directory: {{ ludus_litterbox_install_dir }}\\LitterBox"
          - "Web interface: http://{{ ludus_litterbox_host }}:{{ ludus_litterbox_port }}"
          - "To start LitterBox:"
          - "  - Use the desktop shortcut 'LitterBox'"
          - "  - Or run: {{ ludus_litterbox_install_dir }}\\start_litterbox.bat"
          - "  - Or manually: cd {{ ludus_litterbox_install_dir }}\\LitterBox && .\\venv\\Scripts\\python.exe litterbox.py"
          - ""
          - "⚠️  SECURITY WARNING: LitterBox is designed for isolated testing environments only!"
          - "Do not use in production or on systems with sensitive data."